import numpy as np
from scipy.optimize import minimize

# camera_coordinates = [(40.75,148.69),(44.87,208.65),(38.70,285.86),(30.84,348.57),(111,315.34),(126.27,233.34),(109.20,134.70),(184,344.88),(190.43,258.78),(212.20,188.28),(188.20,132.50),(247.40,242.0),(274.5,339.6),(277.25,125.3),(305.70,191.14),(304.5,266.85),(354.7,346.25),(362,113.1),(380.99,183.16),(426.2,252.6),(445.06,341.14),(529.63,347.94),(502,276.42),(463.6,181.2),(441.25,107.26),(523.38,116.2),(526.4,185.2),(573.16,221.89),(581.18,294.72),(573.24,136.62),(45.80,317.66),(50.3,155.7),(117.1,270.2),(119.15,377.75),(162.54,220.74),(226.1,179.95),(202.58,348.1),(303.6,194.05),(405.05,142),(452.3,211.07),(510.46,362.22),(490.5,274),(537.5,214.85),(551.55,142.4),(448.6,241.12),(384.9,194.94),(391.5,154.5),(260.58,139.8),(205.4,248.24),(285.94,311.2),(175.3,333.6),(47.95,294.86),(99.57,147.06),(202.7,121.3),(410.6,184.6),(539.4,325.9),(202.3,176.1),(192.4,308.3),(263.3,250.8),(289.25,153.3),(338.5,247.5),(332.8,319.7)
   
# ]

# robot_coordinates = [(264.44,152.78),(230.47,149.11),(185.99,152.57),(149.0,157.98),(168.32,108.79),(215.86,100.7),(272.37,110.76),(153.84,67.08),(200.40,64.09),(241.51,51.53),(273.44,65.64),(212.3732,31.52),(157.16,15.36),(276.61,14.32),(238.80,-1.1),(198.14,-20.39),(152.97,-29.40),(284.88,-33.18),(243.94,-43.38),(205.38,-69.68),(156.32,-80.83),(151.20,-128.18),(192.55,-112.43),(245.83,-90.43),(288.32,-78.44),(282.56,-125.23),(243.08,-125.84),(222.87,-153.43),(181.90,-158.44),(271.57,-153.73),(167.2478, 148.5512), (259.8666, 146.3221), (195.4354, 106.6201), (133.8396, 104.711), (222.8025, 79.1691), (246.6662, 42.5807), (151.8854, 56.4325), (237.5577, -1.9754), (266.7827, -59.2447), (228.2988, -85.3038), (142.358, -117.4367), (193.4828, -106.6008), (225.1698, -133.4458), (267.9928, -142.3706), (211.1925, -84.0687), (237.6547, -47.5006), (260.1894, -51.3799), (269.1064, 23.9337), (207.0769, 54.8032), (171.7253, 8.4961), (158.6674, 71.553), (179.1367, 146.2537), (266.526, 115.7751), (280.5286, 56.3399), (243.2001, -62.443), (163.2918, -134.9595), (247.6008, 55.9464), (172.0529, 61.4944), (205.9064, 19.848), (260.9423, 6.7528), (207.8087, -21.6797), (168.3229, -17.2459)
    
# ]
# camera_coordinates = [(36.50,363.94),(25.53,226.76),(56.49,181.27),(51.5,332.4),(89.95,306.48),(98.24,214.10),(151.5,122.40),(155.18,216.38),(131.8,297),(161.2,386.9),(159.76,216.44),(159.9,127.5),(238.0,168.7),(200.35,253.30),(225.8,360.4),(246.3,316.6),(241.65,222.98),(268.6,129.5),(359.0,126.12),(341,204.5),(309.78,253),(297.57,331.1),(351.28,355.8),(352.2,256.4),(346.4,203.2),(341.8,157.06),(402.3,127.8),(399.9,220.86),(394.5,316.65),(446.3,337.6),(423.54,222.94),(449.1,147.8),(488.7,239.6),(473.85,344),(553.29,317.9),(507.95,185.75),(532.54,152.4),(565.5,172.19),(561.78,239.6),(544,278.7),(612.2,289.9),(346.05,354.25),(496.64,324.18),(466.88,323.06),(213.52,228.25),(319.4,163.55),(295.1,281.15),(349.2,272.7),(375.75,371.5),(236.75,358.89),(436.6,343.75),(562.6,349.4),(556.45,197.44),(450.7,148.06),(383.2,210.25),(385.8,121.05),(62.4,155.3),(118.6,220.9)
# ]
# print(len(camera_coordinates))
# robot_coordinates = [(144.91, 149.09), (223.0633, 155.5432), (248.3336, 135.1812), (164.3159, 140.602), (176.4749, 116.9758), (229.9332, 110.6741), (280.3702, 79.4924), (227.0118, 78.0753), (181.8221, 92.8549), (133.5098, 79.5415), (226.7544, 74.9533), (277.7912, 74.3424), (252.5919, 31.1988), (206.3437, 53.1835), (144.8564, 39.6283), (168.9394, 27.5581), (222.6955, 28.6559), (274.6228, 12.0611), (273.3945, -39.1674), (230.9768, -27.2296), (203.8072, -8.9507), (160.4162, -1.2598), (144.7448, -30.8829), (201.0878, -33.2791), (231.4041, -30.8637), (257.3208, -28.8897), (272.5571, -63.7061), (220.3996, -60.1849), (167.7438, -54.5032), (155.0853, -83.9571), (220.7218, -72.2808), (261.6724, -87.838), (210.5269, -108.8662), (151.1683, -99.7995), (164.0922, -144.9363), (237.9519, -121.6581), (258.147, -135.1584), (247.5547, -153.2792), (209.343, -150.7705), (186.1814, -140.4624), (161.7534, -169.875), (142.5601, -140.8577), (160.8438, -113.5988), (163.1788, -96.3002), (219.1933, 44.9706), (254.2911, -15.8805), (188.6802, -0.3486), (191.4338, -30.955), (135.4152, -42.895), (142.7117, 33.4265), (151.1051, -79.2032), (143.7937, -150.874), (230.6277, -149.5189), (259.6251, -88.2198), (226.1818, -49.5709), (276.5102, -54.3374),(263.3374, 130.5199),(226.06,98.94)
    
# ]
# print(len(robot_coordinates))
#Chốt tọa độ 
# camera_coordinates = [(45.80,317.66),(50.3,155.7),(117.1,270.2),(119.15,377.75),(162.54,220.74),(226.1,179.95),(202.58,348.1),(303.6,194.05),(405.05,142),(452.3,211.07),(510.46,362.22),(490.5,274),(537.5,214.85),(551.55,142.4),(448.6,241.12),(384.9,194.94),(391.5,154.5),(260.58,139.8),(205.4,248.24),(285.94,311.2),(175.3,333.6),(47.95,294.86),(99.57,147.06),(202.7,121.3),(410.6,184.6),(539.4,325.9),(202.3,176.1),(192.4,308.3),(263.3,250.8),(289.25,153.3),(338.5,247.5),(332.8,319.7)
   
# ]

# robot_coordinates = [(167.2478, 148.5512), (259.8666, 146.3221), (195.4354, 106.6201), (133.8396, 104.711), (222.8025, 79.1691), (246.6662, 42.5807), (151.8854, 56.4325), (237.5577, -1.9754), (266.7827, -59.2447), (228.2988, -85.3038), (142.358, -117.4367), (193.4828, -106.6008), (225.1698, -133.4458), (267.9928, -142.3706), (211.1925, -84.0687), (237.6547, -47.5006), (260.1894, -51.3799), (269.1064, 23.9337), (207.0769, 54.8032), (171.7253, 8.4961), (158.6674, 71.553), (179.1367, 146.2537), (266.526, 115.7751), (280.5286, 56.3399), (243.2001, -62.443), (163.2918, -134.9595), (247.6008, 55.9464), (172.0529, 61.4944), (205.9064, 19.848), (260.9423, 6.7528), (207.8087, -21.6797), (168.3229, -17.2459)
    

# ]

#toa do chot2 : 
camera_coordinates = [ 
    (85.4,317.1),
    (64.4,219.7),
    (162.4,341.4),
    (156.3,175.2),
    (237.6,241.3),
    (263.7,333),
    (281.9,182.5),
    (359.5,256.1),
    (383.1,168.3),
    (400.2,323.3),
    (487.3,319.8),
    (467.8,230.3),
    (493.7,153.4),
    (557.7,192.3),
    (578,255.9)
    ,(37.75, 336.5),
    (58.5, 250),
    (35, 152.5),
    (131, 357),
    (152.25, 220.5),
    (179.25, 137.75),
    (200.5, 338),
    (249, 274.5),
    (266.25, 159.75),
    (298.5, 249.75),
    (342.25, 204.5),
    (365.25, 279),
    (411, 137),
    (403.5, 353.75),
    (452, 236),
    (495, 155.75),
    (486.5, 354),
    (528, 279.5),
    (587.75, 338.5),
    (576, 238.5),
    (572, 140.25)
    # Add more coordinates here
]

# List of corresponding robot arm coordinates (x, y)
robot_coordinates = [(167.57,123.89),
    (222.89,136.59),
    (154.16,79.18),
    (247.49,83.08),
    (212.01,36.90),
    (159.49,21.64),
    (243.98,11.73),
    (202.23,-31.07),
    (251.85,-45.03),
    (165.57,-53.88),
    (167.54,-103.41),
    (217.31,-92.49),
    (260.62,-107.11),
    (239.22,-143.12),
    (202.54,-155.31),
    (157.57, 150.73),
    (207.23, 137.77),
    (262.4, 151.76),
    (146.31, 97.37),
    (222.76, 84.05),
    (269.16, 68.18),
    (156.74, 57),
    (193.18, 29.59),
    (255.89, 18.59),
    (151.41, 1.46),
    (230.14, -23.58),
    (189.22, -36.27),
    (268.11, -62),
    (147.57, -56.31),
    (212.82, -84.26),
    (257.13, -109.3),
    (145.98, -103.2),
    (187, -126.61),
    (152.99, -162.61),
    (210.09, -156.38),
    (265, -154.28)
   
]

# #toa do  : 
# camera_coordinates = [ (45.80,317.66),(50.3,155.7),(117.1,270.2),(119.15,377.75),(162.54,220.74),(226.1,179.95),(202.58,348.1),(303.6,194.05),(405.05,142),(452.3,211.07),(510.46,362.22),(490.5,274),(537.5,214.85),(551.55,142.4),(448.6,241.12),(384.9,194.94),(391.5,154.5),(260.58,139.8),(205.4,248.24),(285.94,311.2),(175.3,333.6),(47.95,294.86),(99.57,147.06),(202.7,121.3),(410.6,184.6),(539.4,325.9),(202.3,176.1),(192.4,308.3),(263.3,250.8),(289.25,153.3),(338.5,247.5),(332.8,319.7)
#    ,
#     (85.4,317.1),
#     (64.4,219.7),
#     (162.4,341.4),
#     (156.3,175.2),
#     (237.6,241.3),
#     (263.7,333),
#     (281.9,182.5),
#     (359.5,256.1),
#     (383.1,168.3),
#     (400.2,323.3),
#     (487.3,319.8),
#     (467.8,230.3),
#     (493.7,153.4),
#     (557.7,192.3),
#     (578,255.9)
#     ,(37.75, 336.5),
#     (58.5, 250),
#     (35, 152.5),
#     (131, 357),
#     (152.25, 220.5),
#     (179.25, 137.75),
#     (200.5, 338),
#     (249, 274.5),
#     (266.25, 159.75),
#     (298.5, 249.75),
#     (342.25, 204.5),
#     (365.25, 279),
#     (411, 137),
#     (403.5, 353.75),
#     (452, 236),
#     (495, 155.75),
#     (486.5, 354),
#     (528, 279.5),
#     (587.75, 338.5),
#     (576, 238.5),
#     (572, 140.25)
#     # Add more coordinates here
# ]

# # List of corresponding robot arm coordinates (x, y)
# robot_coordinates = [(167.2478, 148.5512), (259.8666, 146.3221), (195.4354, 106.6201), (133.8396, 104.711), (222.8025, 79.1691), (246.6662, 42.5807), (151.8854, 56.4325), (237.5577, -1.9754), (266.7827, -59.2447), (228.2988, -85.3038), (142.358, -117.4367), (193.4828, -106.6008), (225.1698, -133.4458), (267.9928, -142.3706), (211.1925, -84.0687), (237.6547, -47.5006), (260.1894, -51.3799), (269.1064, 23.9337), (207.0769, 54.8032), (171.7253, 8.4961), (158.6674, 71.553), (179.1367, 146.2537), (266.526, 115.7751), (280.5286, 56.3399), (243.2001, -62.443), (163.2918, -134.9595), (247.6008, 55.9464), (172.0529, 61.4944), (205.9064, 19.848), (260.9423, 6.7528), (207.8087, -21.6797), (168.3229, -17.2459)
    
# ,(167.57,123.89),
#     (222.89,136.59),
#     (154.16,79.18),
#     (247.49,83.08),
#     (212.01,36.90),
#     (159.49,21.64),
#     (243.98,11.73),
#     (202.23,-31.07),
#     (251.85,-45.03),
#     (165.57,-53.88),
#     (167.54,-103.41),
#     (217.31,-92.49),
#     (260.62,-107.11),
#     (239.22,-143.12),
#     (202.54,-155.31),
#     (157.57, 150.73),
#     (207.23, 137.77),
#     (262.4, 151.76),
#     (146.31, 97.37),
#     (222.76, 84.05),
#     (269.16, 68.18),
#     (156.74, 57),
#     (193.18, 29.59),
#     (255.89, 18.59),
#     (151.41, 1.46),
#     (230.14, -23.58),
#     (189.22, -36.27),
#     (268.11, -62),
#     (147.57, -56.31),
#     (212.82, -84.26),
#     (257.13, -109.3),
#     (145.98, -103.2),
#     (187, -126.61),
#     (152.99, -162.61),
#     (210.09, -156.38),
#     (265, -154.28)
   
# ]




# Define the transformation matrix parameters (scale_x, scale_y, rotate, translate_x, translate_y)
initial_guess = [1.0, 1.0, 0.0, 0.0, 0.0]


# Function to compute the error between transformed camera coordinates and robot coordinates
def error_function(params):
    # Extract the transformation matrix parameters
    scale_x, scale_y, rotate, translate_x, translate_y = params

    # Construct the 2D transformation matrix
    transformation_matrix = np.array([
        [scale_x * np.cos(rotate), -scale_y * np.sin(rotate), translate_x],
        [scale_x * np.sin(rotate), scale_y * np.cos(rotate), translate_y]
    ])

    # Apply the transformation matrix to all camera coordinates
    transformed_camera_coordinates = np.dot(
        np.hstack((np.array(camera_coordinates), np.ones((len(camera_coordinates), 1)))), transformation_matrix.T)

    # Calculate the error as the sum of squared differences between robot and transformed camera coordinates
    error = np.sum((np.array(robot_coordinates) - transformed_camera_coordinates[:, :2]) ** 2)

    return error


# Use scipy's minimize function to find the optimal transformation matrix
result = minimize(error_function, initial_guess, method='BFGS')

# Extract the optimal transformation matrix parameters
optimal_params = result.x
scale_x, scale_y, rotate, translate_x, translate_y = optimal_params

# Construct the optimal transformation matrix
optimal_transformation_matrix = np.array([[scale_x * np.cos(rotate), -scale_y * np.sin(rotate), translate_x],
    [scale_x * np.sin(rotate), scale_y * np.cos(rotate), translate_y]
])

# Print the optimal transformation matrix
print("Optimal Transformation Matrix:")
print(optimal_transformation_matrix)